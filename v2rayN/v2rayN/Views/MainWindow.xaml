using System;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using ServiceLib.Manager;

namespace v2rayN.Views
{
    public partial class LoginWindow : Window
    {
        public LoginWindow()
        {
            InitializeComponent();
        }

        private async void BtnLogin_Click(object sender, RoutedEventArgs e)
        {
            string username = txtUsername.Text;
            string password = txtPassword.Password;

            if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
            {
                MessageBox.Show("Please enter username and password.");
                return;
            }

            btnLogin.IsEnabled = false;
            btnLogin.Content = "Logging in...";

            try
            {
                string deviceId = GetDeviceId();
                // بهتر است ورژن را داینامیک بگیریم
                string appVersion = System.Reflection.Assembly.GetExecutingAssembly().GetName().Version.ToString();

                await MidPanelManager.Instance.LoginAsync(username, password, deviceId, appVersion);

                if (MidPanelManager.Instance.IsLoggedIn)
                {
                    new MainWindow().Show();
                    this.Close();
                }
                else
                {
                    MessageBox.Show("Login failed. Please check credentials.");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error: {ex.Message}");
            }
            finally
            {
                btnLogin.IsEnabled = true;
                btnLogin.Content = "LOGIN";
            }
        }

        private string GetDeviceId()
        {
            return Environment.MachineName + "_" + Environment.UserName;
        }

        private void Window_MouseDown(object sender, MouseButtonEventArgs e)
        {
            if (e.ChangedButton == MouseButton.Left)
                this.DragMove();
        }
    }
}